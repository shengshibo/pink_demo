<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/tai.css">
    <link rel="stylesheet" href="./css/mozhi.css">
  </head>
  <body>
    <div id="wrap">
      <div class="head">
        <div class="head-top">
          <!-- logo -->
          <h1 class="logo">
            <a href="http://www.atguigu.com">
              <img src="./img/logo.png">
            </a>
          </h1>
          <!-- 面包屑导航 -->
          <a href="javascript:;" class="menuButton"></a>
          <!-- 按钮排 -->
          <div class="buttons">
            <a href="javascript:;" class="search">搜索</a>
            <a href="javascript:;">登录</a>
            <a href="javascript:;">注册</a>
          </div>
        </div>
        <div class="head-bottom">
          <form method="POST">
            <input type="text" placeholder="请碰我一下">
            <input type="submit" value="搜索">
          </form>
        </div>
        <ul class="mask">
          <li>
            <a href="javascript:;">首页</a>
          </li>
          <li>
            <a href="javascript:;">MV</a>
          </li>
          <li>
            <a href="javascript:;">悦单</a>
          </li>
          <li>
            <a href="javascript:;">V榜</a>
          </li>
          <li>
            <a href="javascript:;">音乐</a>
          </li>
          <li>
            <a href="javascript:;">商城</a>
          </li>
          <li>
            <a href="javascript:;">节目</a>
          </li>
          <li>
            <a href="javascript:;">饭团</a>
          </li>
          <li>
            <a href="javascript:;">咨询</a>
          </li>
          <li>
            <a href="javascript:;">我的家</a>
          </li>
          <li>
            <a href="javascript:;">APP下载</a>
          </li>
          <li>
            <a href="javascript:;">热门应用</a>
          </li>
        </ul>
      </div>
      <div class="content">
        <!-- 导航 -->
        <div class="mozhi-nav-drag-wrapper">
          <ul class="list">
            <li>
              <a href="javascript:;" class="active">首页</a>
            </li>
            <li>
              <a href="javascript:;">MV</a>
            </li>
            <li>
              <a href="javascript:;">悦单</a>
            </li>
            <li>
              <a href="javascript:;">V榜</a>
            </li>
            <li>
              <a href="javascript:;">音乐</a>
            </li>
            <li>
              <a href="javascript:;">商城</a>
            </li>
            <li>
              <a href="javascript:;">节目</a>
            </li>
            <li>
              <a href="javascript:;">饭团</a>
            </li>
            <li>
              <a href="javascript:;">咨询</a>
            </li>
            <li>
              <a href="javascript:;">我的家</a>
            </li>
            <li>
              <a href="javascript:;">APP下载</a>
            </li>
            <li>
              <a href="javascript:;">热门应用</a>
            </li>
            <li>
              <a href="javascript:;">商城</a>
            </li>
            <li>
              <a href="javascript:;">节目</a>
            </li>
            <li>
              <a href="javascript:;">饭团</a>
            </li>
            <li>
              <a href="javascript:;">咨询</a>
            </li>
            <li>
              <a href="javascript:;">我的家</a>
            </li>
            <li>
              <a href="javascript:;">APP下载</a>
            </li>
            <li>
              <a href="javascript:;">我</a>
            </li>
          </ul>
        </div>
        <!-- 无缝滑屏 -->
        <div class="carousel-wrap" needCarousel needAuto>
          <div class="points-wrap"></div>
        </div>
        <!-- tap选项卡 -->
        <div class="tap-wrap">
          <div class="tap-head">
            <h2>MV主播</h2>
            <span>更多&gt</span>
          </div>
          <div class="tap-nav">
            <a href="javascript:;">全部</a>
            <a href="javascript:;">内地</a>
            <a href="javascript:;">港台</a>
            <a href="javascript:;">欧美</a>
            <a href="javascript:;">韩国</a>
            <a href="javascript:;">日本</a>
            <div class="smallG"></div>
          </div>
          <div class="tap-content">
            <ul class="tap-loading"></ul>
            <ul>
              <li>
                <a href="javascript:;">
                  <img src="./img/a.jpg">
                  <span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
                </a>
                <div class="tap-discuss">
                  <div class="right">
                    <span></span>
                    <span>9176</span>
                  </div>
                  <div class="left">
                    <span></span>
                    <span>6</span>
                  </div>
                </div>
              </li>
              <li>
                <a href="javascript:;">
                  <img src="./img/b.jpg">
                  <span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
                </a>
                <div class="tap-discuss">
                  <div class="right">
                    <span></span>
                    <span>9176</span>
                  </div>
                  <div class="left">
                    <span></span>
                    <span>6</span>
                  </div>
                </div>
              </li>
              <li>
                <a href="javascript:;">
                  <img src="./img/c.jpg">
                  <span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
                </a>
                <div class="tap-discuss">
                  <div class="right">
                    <span></span>
                    <span>9176</span>
                  </div>
                  <div class="left">
                    <span></span>
                    <span>6</span>
                  </div>
                </div>
              </li>
              <li>
                <a href="javascript:;">
                  <img src="./img/d.jpg">
                  <span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
                </a>
                <div class="tap-discuss">
                  <div class="right">
                    <span></span>
                    <span>9176</span>
                  </div>
                  <div class="left">
                    <span></span>
                    <span>6</span>
                  </div>
                </div>
              </li>
              <li>
                <a href="javascript:;">
                  <img src="./img/e.jpg">
                  <span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
                </a>
                <div class="tap-discuss">
                  <div class="right">
                    <span></span>
                    <span>9176</span>
                  </div>
                  <div class="left">
                    <span></span>
                    <span>6</span>
                  </div>
                </div>
              </li>
              <li>
                <a href="javascript:;">
                  <img src="./img/f.jpg">
                  <span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
                </a>
                <div class="tap-discuss">
                  <div class="right">
                    <span></span>
                    <span>9176</span>
                  </div>
                  <div class="left">
                    <span></span>
                    <span>6</span>
                  </div>
                </div>
              </li>
            </ul>
            <ul class="tap-loading"></ul>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="./js/tools.js"></script>
  <script type="text/javascript" src="./js/mozhi.js"></script>
  <script type="text/javascript">
    window.onload = function () {

      document.addEventListener('touchstart', function (ev) {
        ev = ev || event
        ev.preventDefault()
      })
      
      ;(function () {
        var styleNode = document.createElement('style')
        var w = document.documentElement.clientWidth / 16
        styleNode.innerHTML = 'html {font-size: ' + w + 'px !important;}'
        document.head.appendChild(styleNode)
      })()

      // tap选项卡
      /*
        一次move过程:
          touchstart事件触发一次
          touchmove事件触发n次
          touchend事件触发一次

        1. 基本的滑屏逻辑（防抖动）
        2. 结合tap选项卡的实际需求 滑屏
          --- 手指一次move过程没有过1/2
            我们不关心touchmove的触发次数
          --- 手指一次move过程过1/2
            0
            -2w
            touchmove的触发次数必须只有一次
        3. 一个逻辑只被触发一次
          定时器
            控制一个逻辑在一定时间内被触发一次
          立flag
            控制一个逻辑在一类操作过程中被触发一次
        
      */
      tap()
      function tap () {
        var wrap = document.querySelector('#wrap .content .tap-wrap')
        var contentNodes = document.querySelectorAll('#wrap .content .tap-wrap .tap-content')
        var loadings = document.querySelectorAll('#wrap .content .tap-wrap .tap-content .tap-loading')
        var w = wrap.offsetWidth
        for (let i = 0; i < contentNodes.length; i++) {
          move(contentNodes[i])
        }

        function move (content) {
          var loadings = content.querySelectorAll('.tap-loading')
          mozhi.css(content, 'translateX', -w)
          // 滑屏区域content 既是滑屏区域又是滑屏元素
          var startPoint = {x: 0, y: 0}
          var elementPoint = {x: 0, y: 0}
          var isX = true
          var isFirst = true
          var isOver = false
          content.addEventListener('touchstart', function (ev) {
            ev = ev || event
            isFirst = true
            isX = true
            content.style.transition = 'none'

            var touchC = ev.changedTouches[0]
            
            startPoint.x = touchC.clientX
            startPoint.y = touchC.clientY
            elementPoint.x = mozhi.css(content, 'translateX')
            elementPoint.y = mozhi.css(content, 'translateY')
          })
          content.addEventListener('touchmove', function (ev) {
            if (isOver) return
            if (!isX) return
            ev = ev || event
            var touchC = ev.changedTouches[0]
            
            var nowPoint = {x: 0, y: 0}
            var dis = {x: 0, y: 0}
            nowPoint.x = touchC.clientX
            nowPoint.y = touchC.clientY
            dis.x = nowPoint.x - startPoint.x
            dis.y = nowPoint.y - startPoint.y

            if (isFirst) {
              isFirst = false
              if (Math.abs(dis.y) > Math.abs(dis.x)) {
                isX = false
                return
              }
            }
            var translateX = elementPoint.x + dis.x
            mozhi.css(content, 'translateX', translateX)

            // 1/2跳转
            jump(dis.x)
          })
          content.addEventListener('touchend', function (ev) {
            if (isOver) return
            ev = ev || event
            var touchC = ev.changedTouches[0]
            var nowPoint = {x: 0, y: 0}
            var dis = {x: 0, y: 0}
            nowPoint.x = touchC.clientX
            dis.x = nowPoint.x - startPoint.x

            if (Math.abs(dis.x) <= w / 2) {
              content.style.transition = '.5s transform'
                mozhi.css(content, 'translateX', -w)
            }
          })

          // 1/2跳转 ---> 请求
          function jump (disX) {
            if (isOver) return
            
            if (Math.abs(disX) > w / 2) {
              isOver = true
              content.style.transition = '.5s transform'
              var targetX = disX > 0 ? 0 : -2 * w
              mozhi.css(content, 'translateX', targetX)
              // 请求一定要在动画执行完毕后发送
              content.addEventListener('transitionend', endFn)
              content.addEventListener('webkitTransitionEnd', endFn)

              function endFn () {
                /*
                  循环定时器 回调函数的头部第一行清定时器
                  DOM2绑定transitionend事件，回调函数的头部第一行解绑事件

                  超过1/2
                  1. 一开始loading图是隐藏的，loading图需要出现(1/2跳转后，请求发送前)
                  2. 发送请求、处理请求、完成数据的渲染
                    必须动画（content去0或者-2w位置）完成之后，再去进行这一系列的逻辑
                      --- content要回到-w的位置

                */
                content.removeEventListener('transitionend', endFn)
                content.removeEventListener('webkitTransitionEnd', endFn)
                content.style.transition = 'none'
                console.log('测试jump触发次数')
                for (let i = 0; i < loadings.length; i++) {
                  loadings[i].style.opacity = 1
                }
                // 发ajax请求，去服务端拿数据(学完node之后来发一发)
                setTimeout(function () {
                  // 成功content要回到-w的位置，loading图隐藏
                  // 优雅的处理数据
                  for (let i = 0; i < loadings.length; i++) {
                    loadings[i].style.opacity = 0
                  }
                  mozhi.css(content, 'translateX', -w)

                  isOver = false
                }, 2000)
              }
            }
          }
        }
      }

      // 导航的点击变色
      changeColor()
      function changeColor () { // 这种方法比下面的一种代码少很多，因为使用了事件委托，实现方式就是利用了冒泡
        var list = document.querySelector('#wrap > .content > .mozhi-nav-drag-wrapper > .list')
        var aNodes = document.querySelectorAll('#wrap > .content > .mozhi-nav-drag-wrapper > .list > li > a')
        list.addEventListener('touchstart', function (ev) {
          this.isMove = false
        })
        list.addEventListener('touchmove', function (ev) {
          this.isMove = true
        })
        list.addEventListener('touchend', function (ev) {
          if (this.isMove) return
          ev = ev || event
          var touchC = ev.changedTouches[0]
          for (let i = 0; i < aNodes.length; i++) {
            tools.removeClass(aNodes[i], 'active')
          }
          tools.addClass(touchC.target, 'active')
        })
      }
      // 无缝滑屏
      swiper()
      function swiper () {
        var arr = ['img/1.jpg', 'img/2.jpg','img/3.jpg','img/4.jpg','img/5.jpg',]
        mozhi.carousel(arr)
      }

      // 可拖拽的导航
      drag()
      function drag () {
        mozhi.dragNav()
      }

      changeFocus()
      function changeFocus () {
        var inputText = document.querySelector('#wrap .head .head-bottom form input[type="text"]')
        inputText.addEventListener('touchstart', function (ev) {
          ev = ev || event
          this.focus()
          ev.stopPropagation()
          ev.preventDefault()
        })
        document.addEventListener('touchstart', function (ev) {
          ev = ev || event
          inputText.blur()
          ev.stopPropagation()
          ev.preventDefault()
        })
      }

      CMCFMenuButton()
      function CMCFMenuButton () {
        var menuButton = document.querySelector('#wrap .head .head-top .menuButton')
        var mask = document.querySelector('#wrap .head .mask')
        var isShow = false
        menuButton.addEventListener('touchstart', function (ev) {
          ev = ev || event
          var touchC = ev.changedTouches[0]
          if (!isShow) {
            tools.addClass(menuButton, 'active')
            mask.style.display = 'block'
          } else {
            tools.removeClass(menuButton, 'active')
            mask.style.display = 'none'
          }
          isShow = !isShow
          ev.stopPropagation()
          ev.preventDefault()
        })

        document.addEventListener('touchstart', function () {
          if (isShow) {
            tools.removeClass(menuButton, 'active')
            mask.style.display = 'none'
            isShow = !isShow
          }
        })

        mask.addEventListener('touchstart', function (ev) {
          ev = ev || event
          ev.stopPropagation()
          ev.preventDefault()
        })
      }
    }
  </script>
</html>